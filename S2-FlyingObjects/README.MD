# Assignment-2: Deploying a model on AWS Lambda

## Description

 "Flying Objects" is a generated dataset consisting of the images of the following classes:

 1. Large QuadCopters
 2. Small QuadCopters
 3. Winged Drones
 4. Flying Birds

The dataset was generated by the EVA4P2 study group. Below is a sample of the dataset:

![Sample Images](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/DSSample.jpg)

## Dataset EDA

Please refer this notebook for [Detailed EDA](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/EVA4P2_S2_DataAnalysis.ipynb) 

1. **Images per class**
![Images per Class](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/ClassWiseFileCount.jpg)
2. **File Size per Class** ![File Size per Class](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/ClassWiseFileSize.png)
3. **Height/Width distribution per class** ![Height/Width distribution per class](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/ClassWiseHW.png)

Basic data cleaning methods such as removal of zero/invalid sized files and extensions and applied.
Further, based on K-Means over both image size and image height/width, the dataset was further pruned to have ~21443 samples.
Final data was split into training and test samples.

## Data Augmentation:

Following augmentation schemes were used from [Albumentations library](https://github.com/albumentations-team/albumentations):

1. **For Training**: Resize(512x512)-->RandomResizedCrop(224x224)-->CutOut-->Fliplr--->Rotate-->Normalize-->ToTensor
1. **For Testing**: Resize(224x224)-->Normalize-->ToTensor

Augmentation Functions are present in **[this file](https://github.com/rajy4683/RekogNizer/blob/5ade03bd09bf94e43318e3b8af6594478e2b56c3/train_eva4_s2.py#L74)**

## Model and Loss functions:

Model definition can be found **[here](https://github.com/rajy4683/RekogNizer/blob/5ade03bd09bf94e43318e3b8af6594478e2b56c3/basemodelclass.py#L687)**
Pre-trained **MobileNetV2** from torch.hub was used as the backbone.
The original classifier is trained for ImageNet classes, so the classifier layer was replaced with custom classifier for 4 classes with log-softmax activation.
[nn.NLLLoss](https://pytorch.org/docs/stable/generated/torch.nn.NLLLoss.html) was used as Loss function

## Training Strategy:

The training and results are present in **[this notebook](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/EVA4P2_S2_PreFinal.ipynb)**
The notebook invokes **[this script](https://github.com/rajy4683/RekogNizer/blob/master/train_eva4_s2.py)** with various hyperparameters including number of layers to be unfrozen 

1. Overall strategy was to use transfer learning with fine-tuning.
2. Depending upon the accuracy reached, lower layers were unfrozen with Learning Rate range test. Please refer the schematic below 
![Layer Unfreezing](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/ModelFlow.JPG)
1. Final accuracy reached on the test set was ~89.85%

Training results are as below:


Full training results and hyperparameters can be viewed at this [W&B link](https://app.wandb.ai/rajy4683/news5/runs/nzn1q8x5)

## File-wise Details

- [handler.py](https://github.com/rajy4683/EVA4P2/blob/master/S1-BasicDeployment/handler.py): Contains the definition of the lambda function(classify_image) that will invoked on the AWS LAMBDA
- [serverless.yml](https://github.com/rajy4683/EVA4P2/blob/master/S1-BasicDeployment/serverless.yml): Deployment file used by the "serverless" framework to create the end-to-end deployment.
- [package.json](https://github.com/rajy4683/EVA4P2/blob/master/S1-BasicDeployment/package.json): contains the dependency file used during 'npm run deploy' phase.
- [requirements.txt](https://github.com/rajy4683/EVA4P2/blob/master/S1-BasicDeployment/requirements.txt): contains all the external packages that need to be deployed for 'handler.py'
- [imagenet_labels.py](https://github.com/rajy4683/EVA4P2/blob/master/S1-BasicDeployment/imagenet_labels.py): contains an Unordered dict of Imagenet class to name mappings

## Samples from Inferencing

![Input Image for the query](https://github.com/rajy4683/EVA4P2/blob/master/S1-BasicDeployment/LABD.jpg)

![Output of Inferencing from deployed model using Insomnia](https://github.com/rajy4683/EVA4P2/blob/master/S1-BasicDeployment/Output.JPG)

## References:

- EVA4 Course content
- This awesome [Medium Link](https://towardsdatascience.com/scaling-machine-learning-from-zero-to-hero-d63796442526)
