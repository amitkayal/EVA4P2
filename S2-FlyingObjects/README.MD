# Assignment-2: Detecting Flying Object classes

## TOC

1. [Overview](#overview)
2. [Dataset EDA](#dataset-eda)
3. [Data Augmentation](#data-augmentation)
4. [Model and Loss functions](#model-and-loss-functions)
5. [Training Strategy](#training-strategy)
6. [Samples from Inferencing](#samples-from-inferencing)
    1. [Confusion Matrix](#confusion-matrix)
    2. [Misclassified Image Gallery](#misclassified-image-gallery)
7. [Accessing Lambda](#accessing-lambda)
8. [Repo Links](#repo-links)
9. [References](#references)

## Overview

"Flying Objects" is a dataset consisting of images of the following classes:

 1. Large QuadCopters(LQ)
 2. Small QuadCopters(SQ)
 3. Winged Drones(WD)
 4. Flying Birds(Birds)

The dataset was generated by the EVA4P2 study group. Below is a sample of the dataset:

![Sample Images](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/DSSample.jpg)

The objective is to train/fine-tune MobileNetV2 model to distinguish images belogning to above classes and deploy such a model on AWS.

Please refer to [this section](https://github.com/rajy4683/EVA4P2/tree/master/S2-FlyingObjects#accessing-lambda) to access the model from this repo.

## Dataset EDA

Please refer this notebook for [Detailed EDA](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/EVA4P2_S2_DataAnalysis.ipynb)

1. **Images per class**
![Images per Class](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/ClassWiseFileCount.jpg)
2. **File Size per Class** ![File Size per Class](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/ClassWiseFileSize.png)
3. **Height/Width distribution per class** ![Height/Width distribution per class](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/ClassWiseHW.png)

Basic data cleaning methods such as removal of zero/invalid sized files and extensions and applied.
Further, based on K-Means over both image size and image height/width, the dataset was further pruned to have ~21443 samples.
Final data was split into training and test samples.

## Data Augmentation

Following augmentation schemes were used from [Albumentations library](https://github.com/albumentations-team/albumentations):

1. **For Training**: Resize(512x512)-->RandomResizedCrop(224x224)-->CutOut-->Fliplr--->Rotate-->Normalize-->ToTensor
1. **For Testing**: Resize(224x224)-->Normalize-->ToTensor

Augmentation Functions are present in **[this file](https://github.com/rajy4683/RekogNizer/blob/5ade03bd09bf94e43318e3b8af6594478e2b56c3/train_eva4_s2.py#L74)**

## Model and Loss functions

Model definition can be found **[here](https://github.com/rajy4683/RekogNizer/blob/5ade03bd09bf94e43318e3b8af6594478e2b56c3/basemodelclass.py#L687)**

Pre-trained **MobileNetV2** from torch.hub was used as the backbone.
The original classifier is trained for ImageNet classes, so the classifier layer was replaced with custom classifier for 4 classes with log-softmax activation.
[nn.NLLLoss](https://pytorch.org/docs/stable/generated/torch.nn.NLLLoss.html) was used as Loss function

## Training Strategy

The training and results are present in **[this notebook](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/EVA4P2_S2_PreFinal.ipynb)**.
The notebook invokes **[this script](https://github.com/rajy4683/RekogNizer/blob/master/train_eva4_s2.py)** with various hyperparameters including number of layers to be unfrozen

1. Overall strategy was to use transfer learning with fine-tuning.
2. Depending upon the accuracy reached, lower layers were unfrozen with Learning Rate range test. Please refer the schematic below
![Layer Unfreezing](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/ModelFlow.JPG)
3. Final accuracy reached on the test set was ~89.85%

Training results are as below

![Accuracy Results](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/Loss.JPG)

Full training results and hyperparameters can be viewed at this [W&B link](https://app.wandb.ai/rajy4683/news5/runs/1mfa1c17)

## Samples from Inferencing

### Confusion Matrix

Below is the class wise Accuracy and Confusion Matrix

![CCF](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/CCF.JPG)

### Misclassified Image Gallery

As seen in the Confusion Matrix also, the model have much lower accuracy on Small QuadCopters vs Large QuadCopters.

This could be because of overlapping features between such classes and lesser overall images for Small Quadcopters.

![Misclassified objects](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/S2_EDA_Imgs/Misclassified.png)

## Accessing Lambda

The model trained above has been pushed to S3 and can be downloaded **[here](https://rekog-eva4s1.s3.ap-south-1.amazonaws.com/CustomMobileNetV2_8889.pt)**.

[This link](https://github.com/rajy4683/EVA4P2/tree/master/S2-FlyingObjects/lambda_deploy) contains code for deploying to AWS.

Please refer to this [Medium Link](https://towardsdatascience.com/scaling-machine-learning-from-zero-to-hero-d63796442526) awesome guide for further details

For quick access using curl:

`
curl -X POST \
  https://onlsab2xqb.execute-api.ap-south-1.amazonaws.com/dev/classify \
  -H 'cache-control: no-cache' \
  -H 'content-type: multipart/form-data' \
  -F file1=@'<your file name>' `

### Sample Output

`{"file": "file1", "predicted": "That seems to be Flying Birds"}`

## Code Links

- ["Flying Objects" EDA Notebook](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/EVA4P2_S2_DataAnalysis.ipynb)
- [Model and Deployment Notebook](https://github.com/rajy4683/EVA4P2/blob/master/S2-FlyingObjects/EVA4P2_S2_PreFinal.ipynb)
- [Training Scripts](https://github.com/rajy4683/RekogNizer/blob/master/train_eva4_s2.py)
- [Model definition](https://github.com/rajy4683/RekogNizer/blob/5ade03bd09bf94e43318e3b8af6594478e2b56c3/basemodelclass.py#L687)
- [Training Results](https://app.wandb.ai/rajy4683/news5/runs/nzn1q8x5)

## References

- EVA4 Course content
- This awesome [Medium Link](https://towardsdatascience.com/scaling-machine-learning-from-zero-to-hero-d63796442526)
